# =============================================================================
# Caddy Reverse Proxy Configuration
# =============================================================================
# Routes all services through Cloudflare-proxied subdomains.
# DOMAIN is substituted by setup.sh or set via environment.
#
# Note: Basic auth passwords are bcrypt hashes generated by setup.sh
# =============================================================================

# Global settings
{
	email admin@{$DOMAIN}
}

# Grafana - Monitoring dashboards
grafana.{$DOMAIN} {
	reverse_proxy grafana:3000
}

# Langfuse - LLM tracing and observability
langfuse.{$DOMAIN} {
	reverse_proxy langfuse:3000
}

# Loki - Log aggregation
# Push endpoint requires basic auth for external clients
loki.{$DOMAIN} {
	# Require auth for push endpoint (from external Promtail/agents)
	@push {
		path /loki/api/v1/push
	}
	basic_auth @push {
		# Password hash generated by: caddy hash-password --plaintext <password>
		# Replace with actual hash from setup.sh
		loki {$LOKI_PASSWORD_HASH:$2a$14$placeholder}
	}

	# Allow unauthenticated read access (Grafana uses internal network)
	reverse_proxy loki:3100
}

# MLflow - ML experiment tracking
mlflow.{$DOMAIN} {
	reverse_proxy mlflow:5000
}

# LiteLLM - LLM API proxy
# Authentication handled by LiteLLM's master key
litellm.{$DOMAIN} {
	reverse_proxy litellm:4000
}

# Prometheus - Metrics
# Remote write endpoint requires basic auth
prometheus.{$DOMAIN} {
	# Require auth for remote write endpoint
	@write {
		path /api/v1/write
	}
	basic_auth @write {
		# Password hash generated by: caddy hash-password --plaintext <password>
		{$PROMETHEUS_REMOTE_USER:prometheus} {$PROMETHEUS_PASSWORD_HASH:$2a$14$placeholder}
	}

	# Allow read access for Grafana queries (internal network handles security)
	reverse_proxy prometheus:9090
}

# MinIO Console - Object storage management (optional)
minio.{$DOMAIN} {
	reverse_proxy minio:9001
}
