# =============================================================================
# Hetzner Cloud Services Stack
# =============================================================================
# All services for the observability/proxy hub.
# Requires .env file with secrets (generated by setup.sh)
#
# Usage:
#   docker compose up -d
#   docker compose logs -f
# =============================================================================

services:
  # =========================================================================
  # Reverse Proxy
  # =========================================================================
  caddy:
    image: caddy:2
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./configs/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - services
    depends_on:
      - grafana
      - langfuse
      - loki
      - mlflow
      - litellm
      - prometheus

  # =========================================================================
  # Database
  # =========================================================================
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./configs/postgres-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - services
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =========================================================================
  # Object Storage (for Langfuse)
  # =========================================================================
  minio:
    image: minio/minio:latest
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio-data:/data
    networks:
      - services
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MinIO bucket initialization
  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD};
      mc mb --ignore-existing myminio/langfuse;
      mc ilm rule add --expire-days ${MINIO_RETENTION_DAYS:-30} myminio/langfuse || true;
      exit 0;
      "
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    networks:
      - services

  # =========================================================================
  # Langfuse (LLM Tracing)
  # =========================================================================
  langfuse:
    image: langfuse/langfuse:latest
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/langfuse
      NEXTAUTH_URL: https://langfuse.${DOMAIN}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      SALT: ${SALT}
      LANGFUSE_S3_MEDIA_UPLOAD_ENABLED: "true"
      LANGFUSE_S3_MEDIA_UPLOAD_BUCKET: langfuse
      LANGFUSE_S3_MEDIA_UPLOAD_REGION: us-east-1
      LANGFUSE_S3_MEDIA_UPLOAD_ENDPOINT: http://minio:9000
      LANGFUSE_S3_MEDIA_UPLOAD_ACCESS_KEY_ID: ${MINIO_ROOT_USER}
      LANGFUSE_S3_MEDIA_UPLOAD_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD}
      LANGFUSE_S3_MEDIA_UPLOAD_FORCE_PATH_STYLE: "true"
    networks:
      - services
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy

  # =========================================================================
  # Loki (Log Aggregation)
  # =========================================================================
  loki:
    image: grafana/loki:3.0.0
    restart: unless-stopped
    command: -config.file=/etc/loki/config.yaml
    volumes:
      - ./configs/loki-config.yaml:/etc/loki/config.yaml:ro
      - loki-data:/loki
    networks:
      - services

  # =========================================================================
  # Prometheus (Metrics)
  # =========================================================================
  prometheus:
    image: prom/prometheus:v2.54.0
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=${PROMETHEUS_RETENTION_DAYS:-14d}'
      - '--web.enable-remote-write-receiver'
      - '--web.enable-lifecycle'
    volumes:
      - ./configs/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - services

  # =========================================================================
  # Grafana (Dashboards)
  # =========================================================================
  grafana:
    image: grafana/grafana-oss:11.2.0
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD}
      GF_SERVER_ROOT_URL: https://grafana.${DOMAIN}
      GF_INSTALL_PLUGINS: grafana-piechart-panel
    volumes:
      - grafana-data:/var/lib/grafana
      - ./configs/grafana/provisioning:/etc/grafana/provisioning:ro
    networks:
      - services

  # =========================================================================
  # MLflow (ML Experiment Tracking)
  # =========================================================================
  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.17.0
    restart: unless-stopped
    command: >
      mlflow server
      --backend-store-uri postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/mlflow
      --default-artifact-root /mlflow/artifacts
      --host 0.0.0.0
      --port 5000
    volumes:
      - mlflow-artifacts:/mlflow/artifacts
    networks:
      - services
    depends_on:
      postgres:
        condition: service_healthy

  # =========================================================================
  # LiteLLM (LLM Proxy)
  # =========================================================================
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    restart: unless-stopped
    command: --config /app/config.yaml --port 4000 --num_workers 4
    environment:
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/litellm
    volumes:
      - ./configs/litellm-config.yaml:/app/config.yaml:ro
    networks:
      - services
    depends_on:
      postgres:
        condition: service_healthy

# =============================================================================
# Volumes
# =============================================================================
volumes:
  caddy-data:
  caddy-config:
  postgres-data:
  minio-data:
  loki-data:
  prometheus-data:
  grafana-data:
  mlflow-artifacts:

# =============================================================================
# Networks
# =============================================================================
networks:
  services:
    driver: bridge
